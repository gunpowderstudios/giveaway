<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gunpowder Giveaway</title>
  <style>
    :root { --bg:#0b0f19; --card:#121a2b; --muted:#93a4c7; --text:#e8eefc; --accent:#6ee7ff; --danger:#ff6b6b; --ok:#7CFF9A; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#060914, #0b0f19); color:var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 6px; font-size: 28px; letter-spacing: .2px; }
    .sub { margin:0 0 18px; color:var(--muted); }
    .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap: 18px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    .card { background:rgba(18,26,43,.92); border:1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    label { display:block; font-size: 13px; color: var(--muted); margin: 12px 0 6px; }
    input, textarea, select { width:100%; background:#0c1223; color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 10px 12px; outline:none; }
    textarea { min-height: 180px; resize: vertical; }
    .row { display:flex; gap: 10px; }
    .row > * { flex:1; }
    button { background: linear-gradient(135deg, #1b3cff, #00e5ff); color:#001022; font-weight: 700; border: 0; border-radius: 12px; padding: 10px 12px; cursor:pointer; }
    button.secondary { background:#0c1223; color:var(--text); border:1px solid rgba(255,255,255,.16); font-weight: 600; }
    button.danger { background: rgba(255,107,107,.15); color: var(--danger); border:1px solid rgba(255,107,107,.35); }
    .small { font-size: 12px; color: var(--muted); line-height: 1.35; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; border:1px solid rgba(255,255,255,.14); color: var(--muted); }
    .ok { color: var(--ok); }
    .warn { color: var(--danger); }
    .list { margin: 10px 0 0; padding: 0; list-style: none; }
    .list li { padding: 10px 10px; border-radius: 12px; background:#0c1223; border:1px solid rgba(255,255,255,.10); margin-bottom: 8px; display:flex; justify-content:space-between; gap: 10px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap: 12px; flex-wrap:wrap; }
    .right { display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .hr { height:1px; background: rgba(255,255,255,.10); margin: 14px 0; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Gunpowder Giveaway</h1>
        <p class="sub">Pick random winners from Instagram comments (deduped) — runs 100% in your browser.</p>
      </div>
      <div class="right">
        <span class="pill">No login • No servers • Local-only</span>
        <button class="secondary" id="btnDemo">Load demo data</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <label for="postUrl">Instagram Post URL (for reference)</label>
        <input id="postUrl" placeholder="https://www.instagram.com/p/POSTCODE/" />

        <div class="row">
          <div>
            <label for="numWinners">Number of winners</label>
            <input id="numWinners" type="number" min="1" value="3" />
          </div>
          <div>
            <label for="dedupeMode">Ignore multiple posters</label>
            <select id="dedupeMode">
              <option value="username" selected>One entry per username (recommended)</option>
              <option value="username_plus_name">Stricter: username + name</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="minCommentLength">Optional: minimum comment length</label>
            <input id="minCommentLength" type="number" min="0" value="0" />
          </div>
          <div>
            <label for="requireKeyword">Optional: required keyword (case-insensitive)</label>
            <input id="requireKeyword" placeholder="e.g. 'dungeon' (leave blank to ignore)" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="excludeList">Exclude list (one username per line)</label>
            <textarea id="excludeList" placeholder="e.g.
yourbrandaccount
botsuspected
friend_you_want_to_exclude"></textarea>
            <div class="small">Tip: put your own account here so it never wins.</div>
          </div>
        </div>

        <div class="hr"></div>

        <label>Paste comments JSON <span class="small">(from DevTools → Network → comments request → copy response)</span></label>
        <textarea id="jsonInput" placeholder='Paste JSON here. The app supports a few common shapes:
- Array of comments
- { comments: [...] }
- Instagram-ish: { data: [...] } where each item includes a user/username field'></textarea>

        <div class="row" style="align-items:center; margin-top:10px;">
          <button id="btnPick">Pick winners</button>
          <button class="secondary" id="btnClear">Clear</button>
          <input id="fileInput" type="file" accept=".json,application/json" class="hidden" />
          <button class="secondary" id="btnUpload">Upload JSON</button>
        </div>

        <p class="small" id="status"></p>

        <details style="margin-top:10px;">
          <summary class="small">How to get the comments JSON (quick steps)</summary>
          <div class="small" style="margin-top:8px;">
            <ol>
              <li>Open the Instagram post in your browser while logged in.</li>
              <li>Press <b>F12</b> → <b>Network</b> tab.</li>
              <li>Scroll comments / click to load more comments.</li>
              <li>In Network, find a request that looks like <code>/api/v1/media/</code>… or contains <code>comments</code>.</li>
              <li>Click it → <b>Response</b> → copy the JSON → paste it above.</li>
            </ol>
            If you want, I can also tweak this to match the exact JSON shape you’re seeing.
          </div>
        </details>
      </div>

      <div class="card">
        <div class="row">
          <button class="secondary" id="btnCopy" disabled>Copy winners</button>
          <button class="secondary" id="btnExport" disabled>Export winners JSON</button>
        </div>

        <label>Eligible users</label>
        <div class="small" id="eligibleMeta">None yet.</div>

        <label>Winners</label>
        <ul class="list" id="winnersList"></ul>

        <div class="hr"></div>

        <label>Audit log</label>
        <div class="small mono" id="audit" style="white-space:pre-wrap;"></div>

        <div class="hr"></div>
        <p class="small">
          Randomness uses <code>crypto.getRandomValues</code> (secure).<br/>
          Everything runs locally — no data is sent anywhere.
        </p>
      </div>
    </div>
  </div>

<script>
  // Gunpowder Giveaway — single-file local-only app

  const el = (id) => document.getElementById(id);

  const postUrl = el('postUrl');
  const numWinners = el('numWinners');
  const dedupeMode = el('dedupeMode');
  const minCommentLength = el('minCommentLength');
  const requireKeyword = el('requireKeyword');
  const excludeList = el('excludeList');
  const jsonInput = el('jsonInput');

  const btnPick = el('btnPick');
  const btnClear = el('btnClear');
  const btnCopy = el('btnCopy');
  const btnExport = el('btnExport');
  const btnUpload = el('btnUpload');
  const fileInput = el('fileInput');
  const btnDemo = el('btnDemo');

  const status = el('status');
  const winnersList = el('winnersList');
  const eligibleMeta = el('eligibleMeta');
  const audit = el('audit');

  let lastWinners = [];
  let lastEligible = [];

  function setStatus(msg, kind='') {
    status.className = 'small ' + (kind === 'ok' ? 'ok' : kind === 'warn' ? 'warn' : '');
    status.textContent = msg;
  }

  function secureRandomInt(maxExclusive) {
    // unbiased via rejection sampling
    if (maxExclusive <= 0) throw new Error('maxExclusive must be > 0');
    const uint32Max = 0xFFFFFFFF;
    const limit = Math.floor((uint32Max + 1) / maxExclusive) * maxExclusive;
    const buf = new Uint32Array(1);
    while (true) {
      crypto.getRandomValues(buf);
      const x = buf[0];
      if (x < limit) return x % maxExclusive;
    }
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = secureRandomInt(i + 1);
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function parseExcludeSet() {
    const lines = (excludeList.value || '')
      .split('\n')
      .map(s => s.trim().replace(/^@/, ''))
      .filter(Boolean);
    return new Set(lines.map(s => s.toLowerCase()));
  }

  function normalizeUsername(u) {
    return (u || '').toString().trim().replace(/^@/, '');
  }

  function extractCommentsShape(raw) {
    // Supports:
    // 1) Array
    // 2) { comments: [...] }
    // 3) { data: [...] }
    // 4) { items: [...] } (common IG-ish)
    if (Array.isArray(raw)) return raw;
    if (raw && Array.isArray(raw.comments)) return raw.comments;
    if (raw && Array.isArray(raw.data)) return raw.data;
    if (raw && Array.isArray(raw.items)) return raw.items;
    // Sometimes nested:
    if (raw && raw.response && Array.isArray(raw.response.comments)) return raw.response.comments;
    return null;
  }

  function getUserFromComment(c) {
    // Try common fields across IG-ish and scraper exports
    const userObj = c?.user || c?.owner || c?.from || c?.author || null;
    const username =
      normalizeUsername(
        userObj?.username ||
        userObj?.userName ||
        c?.username ||
        c?.user_name ||
        c?.author_username ||
        c?.owner_username ||
        ''
      );

    const fullName =
      (userObj?.full_name || userObj?.fullName || c?.full_name || c?.name || c?.author_name || '').toString().trim();

    const text =
      (c?.text || c?.comment || c?.content || c?.body || '').toString();

    return { username, fullName, text };
  }

  function buildEligibleUsers(comments) {
    const exclude = parseExcludeSet();
    const minLen = Math.max(0, parseInt(minCommentLength.value || '0', 10));
    const keyword = (requireKeyword.value || '').trim().toLowerCase();
    const mode = dedupeMode.value;

    const map = new Map(); // key -> user
    let dropped = { noUser:0, excluded:0, tooShort:0, missingKeyword:0, dupes:0 };

    for (const c of comments) {
      const { username, fullName, text } = getUserFromComment(c);

      if (!username) { dropped.noUser++; continue; }
      if (exclude.has(username.toLowerCase())) { dropped.excluded++; continue; }
      if (text.trim().length < minLen) { dropped.tooShort++; continue; }
      if (keyword && !text.toLowerCase().includes(keyword)) { dropped.missingKeyword++; continue; }

      const key = (mode === 'username_plus_name')
        ? (username.toLowerCase() + '|' + (fullName||'').toLowerCase())
        : username.toLowerCase();

      if (map.has(key)) { dropped.dupes++; continue; }

      map.set(key, { username, fullName, exampleComment: text.trim().slice(0, 140) });
    }

    return { eligible: Array.from(map.values()), dropped };
  }

  function renderWinners(winners) {
    winnersList.innerHTML = '';
    winners.forEach((w, idx) => {
      const li = document.createElement('li');
      const left = document.createElement('div');
      left.innerHTML = `<b>#${idx+1}</b> <span class="mono">@${escapeHtml(w.username)}</span>${w.fullName ? ` <span class="small">(${escapeHtml(w.fullName)})</span>` : ''}`;
      const right = document.createElement('div');
      right.className = 'small';
      right.textContent = w.exampleComment ? `“${w.exampleComment}”` : '';
      li.appendChild(left);
      li.appendChild(right);
      winnersList.appendChild(li);
    });
  }

  function escapeHtml(s) {
    return (s || '').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function updateAudit(meta) {
    const now = new Date().toISOString();
    const url = (postUrl.value || '').trim();
    const lines = [];
    lines.push(`Run: ${now}`);
    if (url) lines.push(`Post: ${url}`);
    lines.push(`Eligible: ${meta.eligibleCount}`);
    lines.push(`Winners requested: ${meta.winnersRequested}`);
    lines.push(`Dedupe: ${dedupeMode.value}`);
    lines.push(`Min comment length: ${minCommentLength.value || 0}`);
    lines.push(`Keyword: ${requireKeyword.value ? `"${requireKeyword.value}"` : '(none)'}`);
    lines.push(`Excluded usernames: ${meta.excludedCount}`);
    lines.push(`Dropped: noUser=${meta.dropped.noUser}, excluded=${meta.dropped.excluded}, tooShort=${meta.dropped.tooShort}, missingKeyword=${meta.dropped.missingKeyword}, dupes=${meta.dropped.dupes}`);
    if (meta.winners && meta.winners.length) {
      lines.push(`Winners:`);
      meta.winners.forEach((w, i) => lines.push(`  ${i+1}. @${w.username}${w.fullName ? ` (${w.fullName})` : ''}`));
    }
    lines.push(`—`);
    audit.textContent = lines.join('\n') + '\n' + audit.textContent;
  }

  function pickWinners(eligible, count) {
    const n = Math.min(count, eligible.length);
    const shuffled = shuffle(eligible);
    return shuffled.slice(0, n);
  }

  function refreshMeta() {
    eligibleMeta.textContent = lastEligible.length
      ? `${lastEligible.length} eligible unique users loaded.`
      : `None yet.`;
  }

  function setButtons() {
    const hasWinners = lastWinners.length > 0;
    btnCopy.disabled = !hasWinners;
    btnExport.disabled = !hasWinners;
  }

  btnPick.addEventListener('click', () => {
    winnersList.innerHTML = '';
    lastWinners = [];
    setButtons();

    const n = parseInt(numWinners.value || '1', 10);
    if (!Number.isFinite(n) || n < 1) {
      setStatus('Please enter a valid number of winners (1 or more).', 'warn');
      return;
    }

    let raw;
    try {
      raw = JSON.parse(jsonInput.value);
    } catch (e) {
      setStatus('That doesn’t look like valid JSON. Paste the comments JSON response from DevTools.', 'warn');
      return;
    }

    const comments = extractCommentsShape(raw);
    if (!comments) {
      setStatus('Couldn’t find a comments array in that JSON. If you paste your JSON here, I can adapt the parser to it.', 'warn');
      return;
    }

    const { eligible, dropped } = buildEligibleUsers(comments);
    lastEligible = eligible;
    refreshMeta();

    if (eligible.length === 0) {
      setStatus('No eligible users found after filtering/deduping. Check your exclude list / keyword / min length.', 'warn');
      updateAudit({
        eligibleCount: 0,
        winnersRequested: n,
        excludedCount: parseExcludeSet().size,
        dropped,
        winners: []
      });
      return;
    }

    const winners = pickWinners(eligible, n);
    lastWinners = winners;

    renderWinners(winners);
    setButtons();

    setStatus(`Picked ${winners.length} winner(s) from ${eligible.length} eligible users.`, 'ok');

    updateAudit({
      eligibleCount: eligible.length,
      winnersRequested: n,
      excludedCount: parseExcludeSet().size,
      dropped,
      winners
    });
  });

  btnClear.addEventListener('click', () => {
    jsonInput.value = '';
    winnersList.innerHTML = '';
    lastWinners = [];
    lastEligible = [];
    refreshMeta();
    setButtons();
    setStatus('Cleared.', '');
  });

  btnCopy.addEventListener('click', async () => {
    const lines = lastWinners.map((w, i) => `${i+1}. @${w.username}${w.fullName ? ` (${w.fullName})` : ''}`);
    const text = `Gunpowder Giveaway winners:\n` + lines.join('\n');
    try {
      await navigator.clipboard.writeText(text);
      setStatus('Copied winners to clipboard.', 'ok');
    } catch {
      setStatus('Could not access clipboard (browser blocked). You can manually select and copy from the winners list.', 'warn');
    }
  });

  btnExport.addEventListener('click', () => {
    const payload = {
      app: 'Gunpowder Giveaway',
      postUrl: (postUrl.value || '').trim(),
      timestamp: new Date().toISOString(),
      settings: {
        winners: parseInt(numWinners.value || '1', 10),
        dedupeMode: dedupeMode.value,
        minCommentLength: parseInt(minCommentLength.value || '0', 10),
        requireKeyword: requireKeyword.value || '',
        excludedUsernames: Array.from(parseExcludeSet())
      },
      eligibleCount: lastEligible.length,
      winners: lastWinners
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'gunpowder-giveaway-winners.json';
    a.click();
    URL.revokeObjectURL(a.href);
    setStatus('Exported winners JSON.', 'ok');
  });

  btnUpload.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    jsonInput.value = text;
    setStatus(`Loaded ${file.name}. Now click “Pick winners”.`, 'ok');
    fileInput.value = '';
  });

  btnDemo.addEventListener('click', () => {
    const demo = {
      comments: [
        { text: "Love this! Bag of Dungeon is ace", user: { username: "alice_rolls", full_name: "Alice" } },
        { text: "Count me in!", user: { username: "bob_the_barbarian", full_name: "Bob" } },
        { text: "DUNGEON!!!", user: { username: "cathy_crit", full_name: "Cathy" } },
        { text: "Another comment (should be ignored as duplicate)", user: { username: "alice_rolls", full_name: "Alice" } },
        { text: "hello", user: { username: "spambot9000", full_name: "" } }
      ]
    };
    jsonInput.value = JSON.stringify(demo, null, 2);
    excludeList.value = "spambot9000";
    postUrl.value = "https://www.instagram.com/p/DEMOPOST/";
    numWinners.value = 2;
    setStatus('Demo data loaded. Click “Pick winners”.', 'ok');
  });

  refreshMeta();
  setButtons();
  setStatus('Paste comments JSON and click “Pick winners”.', '');
</script>
</body>
</html>

